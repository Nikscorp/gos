# 22. Общие принципы дедуктивной верификации программ. Операционная семантика императивных программ. Формальная постановка задачи верификации программ. Логика Хоара: правила вывода и свойства. Автоматизация проверки правильности программ.

Общие принципы дедуктивной верификации:

1. Программа $\pi $ вычисляет отношение $R_{\pi}$ между данными, подаваемыми на вход и получаемыми на выходе 
2. Текст программы $\pi$ — это формальное описание отношения $R_{\pi} $ 
3. Спецификация программы $Φ$ — это формальное описание отношения $R_Φ$ между данными программы 
   * Отношение, описываемое спецификацией, — это требования, которым должно удовлетворять отношение, вычисляемое программой 
4. Формальная верификация программы $\pi$ относительно спецификации $Φ$ — это строгое доказательство того, что программа $\pi $ удовлетворяет требованиям $Φ$, то есть доказательство включения $R_{\pi} \sube R_Ф$ 

Чтобы уметь формально верифицировать программы, нужно: 

1. Строго описать, какие записи мы считаем программами  (синтаксис программ)  и  как программы преобразуют входные данные в выходные  (семантику программ) 

2. Выбрать формальный язык описания требований к программам 

3. Предложить метод проверки того, удовлетворяет ли заданная программа предъявленным к ней требованиям 

Синтаксис императивных программ (сигнатуры $\sigma$) задаётся следующей формой Бэкуса-Наура: 

$\pi $ ::= instr | instr; $\pi$ 

instr ::= $\empty$ |  x:=t  |  **if** $C$ **then $\pi $** **else $\pi$** **fi**  |  **while $C$** **do $\pi$** **od** 

Где

- $\pi $ — программа 
- instr — инструкция (пустая инструкция, присваивание, ветвление, цикл) 

- x — переменная 
-  t—терм 
- $C$ — условие: формула, не содержащая кванторов 

**Операционная семантика**:

- Вычисление программы — это последовательное изменение состояния вычисления 

- Программой задаётся отношение переходов, описывающее, какое состояние вычисления будет получено следующим из произвольного текущего состояния 

- Значение программы — это функция преобразования входных данных в выходные, определяемая на основе транзитивного замыкания отношения переходов 

- Хорошо подходит для описания значения императивных программ 

**Операционная семантика для императивных программ**:

**Состояние управления** — это произвольная программа 

**Состояние данных (оценка переменных)** — это подстановка, отображающая каждую переменную программы в терм, не содержащий переменных 

**Состояние вычисления** — это пара $\langle \pi, \theta \rangle$, где $\pi$ — состояние управления, а $\theta$ — состояние данных

 **Отношение переходов** $\to$ на множестве состояний вычисления для программы $\pi$ в интерпретации $I$ определяется так: 

* если $\langle$x:= t, $\theta \rangle$ $\to$ $\langle \empty, \{x/t\}\theta \rangle$
* если  $I \models C\theta$ , то:   $\langle$**if** $C$ **then** $\pi_1$ **else** $\pi_2$, $\theta \rangle$  $\to$  $\langle \pi_1, \theta \rangle$ 
* если  $I \nvDash Cθ$ ,  то:     $\langle$**if** $C$ **then** $\pi_1$ **else** $\pi_2$, $\theta \rangle$  $\to$  $\langle \pi_2, \theta \rangle$ 
* если  $I \models C\theta$ , то:   $\langle$**while** $C$ **do** $\pi$ **od**, $\theta \rangle$  $\to$  $\langle π$; **while** $C$ **do** $\pi$ **od**, $\theta \rangle$

* если  $I \nvDash Cθ$ ,  то:  $\langle$**while** $C$ **do** $\pi$ **od**, $\theta \rangle$  $\to$  $\langle \empty, \theta \rangle$ 
* если⟨$π_1$, $θ$⟩→⟨$π_1^′$, $η$⟩ , то ⟨ $\pi_1$ ; $\pi_2$ , $\theta$ ⟩ → ⟨ $\pi_1^′$ ;$\pi_2$ ,$\eta$ ⟩  
* $\langle \empty; \pi, \theta \rangle $  $\to$   $\langle \pi, \theta \rangle$ 

**Трасса**  программы $\pi$ на оценке $\theta$ в интерпретации $I$ — это последовательность состояний вычисления вида  $\langle \pi, \theta \rangle \to \langle \pi_1, \theta_1 \rangle \to \langle \pi_2, \theta_2 \rangle \to \dots$ 

**Вычисление программы** $\pi$ на оценке $\theta$ в интерпретации $I$ — это максимальная по длине трасса $\pi$ на $\theta$ в $I$ 

**Результат конечного вычисления** программы $\pi$ на оценке $\theta$ в интерпретации $I$ — это оценка данных последнего состояния вычисления $\pi$ на $\theta$ в $I$ , иными словами, если $\langle \pi, \theta \rangle \to^* \langle \empty, \eta \rangle$, то $\eta$ — результат вычисления $\pi$ на $\theta$ в $I$   

($\to^*$ — транзитивное замыкание отношения $\to$)  

**Формальная постановка задачи верификации**

Предусловие $\phi$ и постусловие $\psi$ — это формулы логики предикатов, а $\pi$ — императивная программа    

Требование корректности $\pi$ относительно $\phi$, $\psi$ записывается в видетриплета Хоара (или тройки Хоара): $\{\phi\} \pi \{\psi\}$ 

Триплет Хоара $\{\phi\} \pi \{\psi\}$ истинен в интерпретации $I$ ($I \models \{\phi\} \pi \{\psi\}$), если для любых оценок $\theta$, $\eta$ верно: если $I \vDash \phi\theta$ и  $\langle \pi, \theta \rangle \to^* \langle \empty, \eta \rangle$,  то $I \models \psi \eta$ 

Программа $\pi$ частично корректна в интерпретации $I$ относительно предусловия $\phi$ и постусловия $\psi$, если  $I \models \{\phi\} \pi \{\psi\}$ 



**Правила вывода**

![image](.\img\22_1.jpg)



**Теорема корректности правил вывода Хоара** 

Для любой интерпретации $I$ и любого правила вывода логики Хоара (SKIP, AS, INF, COMP, IF, WHILE) 

![image](.\img\22_2.jpg)

если $I |= Ψ_1$, $I \vDash Ψ_2$, $I \vDash \phi$ и $I \vDash \psi$,   то   $I \vDash Φ$ 



**Аннотация** — это запись вида $\{\phi\}$, где $\phi$ — произвольная формула 

**Аннотированная программа** — это программа, в которой до и после каждой инструкции могут располагаться последовательности аннотаций 

Аннотация может расцениваться как

* предусловие инструкции, следующей за аннотацией

* постусловие инструкции, предшествующей аннотации

* составная часть триплета, располагающегося в выводе (некоторого исходного триплета) 


**Теорема**. Если существует аннотированная программа $\overline{\pi}$, обосновывающая истинность триплета $\{\phi\} \pi \{\psi\}$ в интерпретации $I$, то $I  \vDash \{\phi\} \pi \{\psi\}$

Проблема корректности программ в общем случае неразрешима

**Слабейшее предусловие** для программы $\pi$ и постусловия $\psi$ в интерпретации $I$ — это формула wpr($\pi, \psi, I$), для которой выполнены следующие условия: 

1. $I \models $ {wpr($\pi,\psi,I$)}  $\pi$  $\{\psi\}$
2. Для любой формулы $\chi$, такой что $I \models \{\chi\} \pi \{\psi\}$, верно  $I \models \chi \to$ wpr($\pi,\psi,I$)   

**Теорема**. $I \models \{\phi\} \pi \{\psi\}$ $\Leftrightarrow$ $I \models \phi \to$ wpr($\pi,\psi,I$) 

Для полной автоматизации проверки корректности программ достаточно иметь два алгоритма: 

1. Алгоритм проверки истинности формул логики предикатов 

2. Алгоритм вычисления слабейшего предусловия для произвольных программ и постусловий


Первый алгоритм зависит от выбора интерпретации программ, и в общем случае может не существовать.

Со вторым алгоритмом всё немного лучше: 

**Теорема**. 

* wpr(x:=t, $\psi$)   =    $\psi${x/t}  
* wpr($\pi_1;\pi_2,~\psi$)      =    wpr($\pi_1$,wpr($\pi_2,\psi$)) 
*  wpr(**if** $C$ **then** $\pi_1$ **else** $\pi_2$ **fi**, $\psi$)   =   $C$ \& wpr($\pi_1,\psi$) ∨ $\neg C$ \& wpr($\pi_2,\psi$) 

Для применения правила WHILE (а также для аннотации цикла, и для вычисления слабейшего предусловия цикла) необходимо предварительно найти подходящую формулу ϕ  - инвариант цикла