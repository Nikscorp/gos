# 28. Понятие потока в сети. Задача о максимальном потоке. Алгоритмы Форда-Фалкерсона и Карзанова. Теорема о максимальном потоке и минимальном разрезе. Сведение задачи составления допустимого расписания с прерываниями для многопроцессорной системы при заданных директивных интервалах к задаче о максимальном потоке в сети.

Сеть состоит из ориентированного графа $G = (V = \{1, \dots, n\},~A = \{(i,j)\}, i,j \in V)$ с двумя выделенными вершинами $s$ - источник и $t$ - сток. Каждая дуга обладает пропускной способностью $u_{ij}$.    $(i,j) \in A :u_{ij} \gt 0$

**Поток**: $f_{ij}, (i,j) \in A$ и его свойства:

1. $f_{ij} \ge 0$
2. $f_{ij} \le u_{ij} ~ \forall (i,j) \in A$
3. $\sum\limits_{j:(j,i_0) \in A}f_{ji_0} - \sum\limits_{j:(i_0,j) \in A}f_{i_0j} = 0, ~\forall i_0 \in V, i_0\neq s,t$ - сохранение потока



$\sum\limits_{(s,j) \in A}f_{sj} - \sum\limits_{(j,s) \in A}f_{js} = M(f)$ - величина потока (Суммарный поток выходящий из истока  минус суммарный поток входящий в исток)



**Задача о максимальном потоке**

Необходимо найти поток $f_{i,j}'$, такой что $ M(f') = \max\limits_{f_{ij}}M(f)$, то есть величина потока максимальна.



**Пример сети с построенным максимальным потоком**

![img](img/28_1.png)



**Алгоритм Форда-Фалкерсона**

Пусть $\pi$ - это путь

по прямой дуге: $\delta_{ij} = u_{ij} - f_{ij} \gt 0$       $f_{ij} = f_{ij} + \delta(\pi)$

По обратной дуге: $\delta_{kj} = f_{kj} \gt 0 $            $f_{kj} = f_{kj} - \delta(\pi)$

$\delta(\pi) = \min\limits_{(i,j) \in \pi}\delta_{i,j}$



**Увеличивающий путь** - это путь $\pi$ (последовательность дуг из истока в сток), для которого величина $\delta(\pi) \gt 0$, которая определяется следующим образом: для каждой дуги $(i,j)$ входящей в путь $\pi$ вычисляется величина $\delta_{ij} = \left\{ \begin{matrix} u_{ij} - f_{ij} > 0 & ,прямая ~ дуга\\ f_{ji} > 0 & ,обратная ~ дуга \end{matrix} \right.$ и  $\delta(\pi) = \min\limits_{(i,j) \in \pi} \delta_{ij}$.

> неформально это путь из истока в сток, вдоль которого можно увеличить поток на некоторую величину. 
>
> Про обратную дугу - можно забирать поток назад

**Алгоритм**

1. $f_{ij}$ - начальный поток ($f_{ij}=0$)
2. Увеличить путь $\pi$ на $\delta(\pi)$ [итеративно]
3. Если нет увеличивающего пути - остановка. [нашли максимальный поток] 

Пусть $u_{ij} \in \N$ - закончится, так как как минимум на 1 каждый раз увеличивается, поэтому алгоритм не зациклится.



**Алгоритм Карзанова**

$G(f) = (V, A(f))$ - **остаточная сеть**

$A(f)$: 

1. $(i,j) \in A, f_{ij} \lt u_{ij}$ $(i,j) \to A(f)$  $v_{ij} = u_{ij} - f_{ij}$
2. $(i,j) \in A, f_{ij} \gt 0$  $(j,i) \to A(f)$  $v_{ji} = f_{ij}$   

**Слоистая сеть** $G^*(f)= (V^*, A^*(f)) $ включает в себя множество всех кратчайших путей (по числу дуг) из источника в сток по слоям:

Нулевой слой $V_0 = \{s\}$

Первый слой $V_1 = \{ i : (s,i) \in A(f)\}$

Второй слой $V_2 = \{j: (j,i) \in A(f), i \in V_1, j \notin V_1 \cup V_0$  и так далее,  на последнем слое может быть не только сток, в промежуточных может быть тупиковые, поэтому надо убирать висячие узлы как только дошли до стока и инцидентные им дуги.

**Тупиковый поток**  - поток, относительно которого нет прямого увеличивающего пути (содержит только прямые дуги) из источника в сток.

**Алгоритм** 

1. Начальный нулевой поток в G
2. Построить G(f) - остаточную сеть
3. Если нет прямого пути из s в t, то стоп $f$ - максимальный поток
4. Построить $G^*(f)$ - слоистую сеть
5. Построить тупиковый поток в $G^*(f)$ - $g_{ij}$
6. Изменить потоки: $(i,j) \in A^*(f) $- прямая $f_{ij} = f_{ij} + g_{ij}$ , для обратных дуг $(i,j) \in A^*(f) $  $f_{ij} = f_{ij} - g_{ij}$
7. Перейти на 2 шаг



**Разрез**: , $V = V_c \cup \overline{V}_c$, $V_c \cap \overline{V}_c = \empty$, $s \in V_c$, $t \in \overline{V}_c$

$u(V_c, \overline{V}_c) = \sum\limits_{i \in V_c, j \in \overline{V}_c} u_{ij}$ - пропускная способность разреза

Разрез с минимальной пропускной способностью называется **минимальным разрезом**.



**Теорема о максимальном потоке и минимальном разрезе**. Величина максимального потока в сети равна величине минимального разреза в сети.

**Задача составления допустимого расписания с прерываниями для многопроцессорной системы:**

Пусть имеется $m$ - процессоров. Задано $N = \{1,…,n \}$ - число работ и для каждой работы заданы  $t_i$ - длительность , $(b_i, f_i]$ - директивный интервал $i$-ой работы ($b_i \lt f_i$ и $t_i \le f_i - b_i$). Во время выполнения работ допускаются прерывания и переключения. Требуется ответить на вопрос существует ли допустимое расписание и как его построить.

**Сведение задачи к задачи поиска максимального потока в сети**:

Обозначим $y_0 \lt y_1 \lt y_2 \lt … y_p$ - все упорядоченные значения $b_i, f_i$

Составим отрезки $I_j=(y_{j-1}, y_j], j=\overline{1,p}$

Сеть будет состоять из узлов $s$, $t$ , $I_j$, $w_i$

$\Delta_j = y_j - y_{j-1}$ - длительность интервала $I_j$ 

Добавляем дуги $(s, I_j)$ с пропускной способностью $m\Delta_j$ 

Добавляем дуги $(I_j,w_i)$, если $I_j \sub (b_i, f_i]$ пропускной способностью $\Delta_j$

Добавляем дуги $(w_i, s)$ пропускной способностью $t_i$

Пример сети для задачи при $m=2$

$\begin{matrix}Раб. & b_i & f_i & t_i \\
1 &  1 & 6 &3 \\ 
2 & 1 & 5 &3 \\ 
3 & 0 & 6 & 3\\
4 & 0 & 4 & 3\\
\end{matrix}$

$I_1 = [0,1], I_2 = [1,4], I_3 = [4,5], I_4=[5,6]$

![img](img\28_2.png)

**Теорема**. Допустимое расписание существует, тогда и только тогда, когда Максимальный поток в G насыщает все выходные дуги.



> **Как можно искать увеличивающий путь**
>
> Есть состояния у каждого узла : ${Н,ПН,ПП}$  - непомеченный, помеченный непросмотренный, помеченный просмотренный
>
> > Метим  следующие для рассмотрения вершины по которым теоретически можно получить увеличивающий путь
>
> 1. S [-], S - $ПН$
> 2. Если нет $ПН$, то останавливаемся (нет увеличивающих путей)
> 3. $i - ПН$, $\forall j - Н, (i,j) \in A, f_{ij} \lt u_{ij} $ - метим $[i]$,    $j - ПН$
>
> ​      $i - ПН$, $\forall j - Н, (i,j) \in A, f_{ij} \gt 0$ - метим $[i]$,    $j - ПН$
>
> ​      далее $i - ПП$
>
> 4. Если $t - Н$, то переходим на шаг 2
>
> ​      Если $t - П$ - построить увеличивающий путь от истока к стоку
>
>  
>
> **Как строить тупиковый поток**
>
> $i \in V^*(f), i\neq s,t$
>
> $a(i)= \min\{ \sum\limits_{(j,i) \in A^*(f)}v_{ji}, \sum\limits_{(j,i) \in A^*(f)}v_{ij}\} $ - **пропускная способность узла**
>
> $a(s) = \sum\limits_{(s,j) \in A^*(f)}v_{sj}$
>
> $a(s) = \sum\limits_{(j,s) \in A^*(f)}v_{jt}$
>
> $i_0$ - самый слабый узел $a(i_0) = \min\limits_{i \in V^*(f)}a(i)$
>
> Выбираем его 
>
> $a_{i_0}$ - будем проталкивать поток от $i_0$ до стока и до истока (можно по разным  дугам, но разрешена только одна недонасыщенная)
>
> После этого вершина $i_0$ исключается из сети  и все полностью насыщенные дуги (если дуги были не полностью насыщены и остались в сети то им изменяем пропускную способность)
>
> и так сначала, пока не останется тупиковый поток

